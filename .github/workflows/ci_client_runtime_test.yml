name: Zombienet Client-Runtime Compatibility Test

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  BASE_IMAGE: docker.io/paritytech/ci-unified:bullseye-1.88.0-2025-06-27-v202506301118
  RUST_LOG: "zombienet_orchestrator=debug,zombienet_provider=debug"
  CARGO_TARGET_DIR: ${{ github.workspace }}/target

jobs:
  build-and-setup:
    runs-on: parity-default
    container:
      image: ${{ env.BASE_IMAGE }}
    outputs:
      runtime_matrix: ${{ steps.set-matrix.outputs.runtime_matrix }}
      binary_tag: ${{ steps.set-matrix.outputs.binary_tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fetch and Sort Versions
        id: set-matrix
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Fetch Runtimes (Latest 3)
          RUNTIMES=$(gh api graphql -f query='
            query {
              repository(owner: "polkadot-fellows", name: "runtimes") {
                releases(first: 20, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes { tagName }
                }
              }
            }' --jq '.data.repository.releases.nodes[].tagName' | grep -E "^v[0-9]+" | head -n 3 | jq -R . | jq -s -c .)

          # 2. Fetch Binaries (Version Sort, Exclude RCs)
          RAW_BINARIES=$(gh api graphql -f query='
            query {
              repository(owner: "paritytech", name: "polkadot-sdk") {
                releases(first: 20, orderBy: {field: CREATED_AT, direction: DESC}) {
                  nodes { tagName }
                }
              }
            }' --jq '.data.repository.releases.nodes[].tagName')
          
          BINARY_TAG=$(echo "$RAW_BINARIES" | grep -E "^polkadot-stable[0-9]+" | grep -v "\-rc" | sort -Vr | head -n 1)

          echo "runtime_matrix=$RUNTIMES" >> $GITHUB_OUTPUT
          echo "binary_tag=$BINARY_TAG" >> $GITHUB_OUTPUT

      - name: Download Binaries
        shell: bash
        run: |
          mkdir -p ./shared-bin
          BIN_TAG="${{ steps.set-matrix.outputs.binary_tag }}"
          NODE_BINS=("polkadot" "polkadot-execute-worker" "polkadot-prepare-worker")
          
          for bin in "${NODE_BINS[@]}"; do
            curl -sL "https://github.com/paritytech/polkadot-sdk/releases/download/$BIN_TAG/$bin" -o "./shared-bin/$bin"
            chmod +x "./shared-bin/$bin"
          done

      - name: Compile Tests
        run: |
          cargo test --test client-runtime --no-run

      - name: Upload Workspace Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-test-and-bins
          path: |
            ./shared-bin/
            ${{ env.CARGO_TARGET_DIR }}/debug/deps/client_runtime-*
            ${{ env.CARGO_TARGET_DIR }}/debug/client-runtime

  test-runtime:
    needs: build-and-setup
    runs-on: parity-default
    name: "Test Runtime: ${{ matrix.runtime_tag }} with binary ${{ needs.build-and-setup.outputs.binary_tag }}"
    container:
      image: ${{ env.BASE_IMAGE }}
    strategy:
      fail-fast: false
      matrix:
        runtime_tag: ${{ fromJson(needs.build-and-setup.outputs.runtime_matrix) }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Workspace Artifacts
        uses: actions/download-artifact@v4
        with:
          name: compiled-test-and-bins
          path: .

      - name: Download Specific Runtime
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifacts
          gh release download "${{ matrix.runtime_tag }}" -R polkadot-fellows/runtimes \
            -p "polkadot_runtime-*.compact.compressed.wasm" \
            --output artifacts/relay_runtime.wasm

      - name: Run Pre-compiled Test
        env:
          RELAY_RUNTIME_PATH: ${{ github.workspace }}/artifacts/relay_runtime.wasm
          ZOMBIE_PROVIDER: native
          PATH: ${{ github.workspace }}/shared-bin:${{ env.PATH }}
        run: |
          chmod +x ./shared-bin/*
          TEST_BIN=$(find ./target/debug/ -maxdepth 1 -name "client-runtime" -type f -executable | head -n 1)
          $TEST_BIN --nocapture