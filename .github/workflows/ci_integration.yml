name: Integration test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RUN_IN_CONTAINER: 1
  FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR: 1
  GHA_CLUSTER_SERVER_ADDR: "https://kubernetes.default:443"
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"
  BASE_IMAGE: docker.io/paritytech/ci-unified:bullseye-1.84.1-2025-01-28-v202502131220
  RUN_IN_CI: "1"
  RUST_LOG: "zombienet_orchestrator=debug,zombienet_provider=debug"
  CARGO_TARGET_DIR: /tmp/target

jobs:
  k8s-integration-test-smoke:
    runs-on: zombienet-arc-runner
    timeout-minutes: 60
    container:
        image: docker.io/paritytech/ci-unified:bullseye-1.84.1-2025-01-28-v202502131220
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          export ZOMBIE_PROVIDER="k8s"
          cargo test --test smoke -- --nocapture

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*
  #
  #
  native-integration-test-smoke:
    runs-on: zombienet-arc-runner
    timeout-minutes: 60
    container:
        image: docker.io/paritytech/ci-unified:bullseye-1.84.1-2025-01-28-v202502131220
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download bins
        shell: bash
        run: |
          for bin in polkadot polkadot-execute-worker polkadot-prepare-worker; do
            echo "downloading $bin";
            curl -L -o /tmp/$bin https://github.com/paritytech/polkadot-sdk/releases/download/polkadot-stable2503-1/$bin;
            chmod 755 /tmp/$bin;
          done
          ls -ltr /tmp
          export PATH=/tmp:$PATH
          echo $PATH

      - name: script
        run: |
          export PATH=/tmp:$PATH
          echo $PATH
          export ZOMBIE_PROVIDER="native"
          cargo test --test smoke-native -- --nocapture

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*
